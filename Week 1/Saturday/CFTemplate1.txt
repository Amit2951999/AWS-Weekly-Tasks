{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description": "A template for event based trigger on S3 using Lmabda",
	"Resources": {
	
		"copyTrigger": {
			"Type": "AWS::Lambda::Function",
			"Properties": {
				"Code": { 
					"S3Bucket": "copy-trigger-lambda-func-bucket",
					"S3Key": "lambda_function2.zip"
				},
				"Description": "This Function is called whenever an object lands on s3, to copy the object to another bucket",
				"Handler": "lambda_function2.lambda_handler",
				"Role": "arn:aws:iam::478055296570:role/S3FullAccess",
				"Runtime" : "python3.9"
			}
		},
		
		"primaryS3bucket": {
			"Type": "AWS::S3::Bucket",
			"DependsOn": [ "copyTrigger" ],
			"Properties": {
				"AccessControl" : "Private",
				"BucketName" : "primary-s3bucket1",
				"NotificationConfiguration" : {
					"EventBridgeConfiguration": {
						"EventBridgeEnabled": true
					},
					"LambdaConfigurations" : [ 
						{
							"Event" : "s3:ObjectCreated:*",
							"Function" : { "Fn::GetAtt": [ "copyTrigger", "Arn"] }
						}
					]
				}
			}
		
		},
		
		"backupS3bucket": {
			"Type": "AWS::S3::Bucket",
			"Properties": {
				"AccessControl" : "Private",
				"BucketName": "backup-s3buckett1"
			}
		},
		
		"AllowS3ToCallLambdaPermission": {
			"Type": "AWS::Lambda::Permission",
			"DependsOn": [ "copyTrigger","primaryS3bucket" ],
			"Properties": {
				"Action": "lambda:InvokeFunction",  
				"FunctionName": { "Fn::GetAtt": [ "copyTrigger", "Arn"] },
				"Principal": "s3.amazonaws.com",
				"SourceArn":  { "Fn::GetAtt" : [ "primaryS3bucket", "Arn" ] }
			}
	    }
	}
}

